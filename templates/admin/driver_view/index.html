<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quan S√°t - {{ driver.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/driver_view.css') }}">
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="header-compact">
            <div class="back-button">
                <a href="/" class="btn-back">‚Üê Quay l·∫°i</a>
            </div>
            <div class="header-info">
                <div class="driver-header-with-edit">
                    <h2 class="driver-name">üöó {{ driver.name }}</h2>
                    <a href="/edit-driver/{{ driver.id }}" class="btn-overlay btn-secondary">
                        ‚úèÔ∏è
                    </a>
                </div>
                <p class="driver-subtitle">Gi√°m s√°t video tr·ª±c ti·∫øp</p>

            </div>
            <div class="status-section">
                <span class="status-badge status-{{ driver.status }}">
                    {{ '‚óè ƒêang ho·∫°t ƒë·ªông' if driver.status == 'active' else '‚óè Kh√¥ng ho·∫°t ƒë·ªông' }}
                </span>
            </div>
        </div>

        <div class="info-bar">
            <div class="info-item">
                <span class="info-icon">üë®‚Äç‚úàÔ∏è</span>
                <span class="info-text">
                    <strong>T√™n t√†i x·∫ø:</strong><br>
                    {{ driver.name }}
                </span>
            </div>
            <div class="info-item">
                <span class="info-icon">üé´</span>
                <span class="info-text">
                    <strong>B·∫±ng l√°i:</strong><br>
                    {{ driver.license }}
                </span>
            </div>
            <div class="info-item">
                <span class="info-icon">üìû</span>
                <span class="info-text">
                    <strong>S·ªë ƒëi·ªán tho·∫°i:</strong><br>
                    {{ driver.phone }}
                </span>
            </div>
            <div class="info-item">
                <span class="info-icon">üì°</span>
                <span class="info-text">
                    <strong>Stream URL:</strong><br>
                    {{ driver.stream_url }}
                </span>
            </div>
        </div>

        <div class="video-section">
            <div class="video-container">
                <!-- Canvas cho WebSocket streaming -->
                <canvas id="yoloCanvas" style="display: none; max-width: 100%; height: auto;"></canvas>

                <!-- Img tag cho MJPEG streaming (fallback) -->
                <img id="videoStream" src="{{ driver.stream_url }}?t={{ timestamp }}" alt="Video Stream"
                    data-base-url="{{ driver.stream_url }}" onerror="handleStreamError()">

                <div id="loadingOverlay" class="loading-overlay">
                    <div class="spinner"></div>
                </div>
                <div id="flashOverlay" class="flash-overlay"></div>
                <div id="errorMessage" class="error-message" style="display: none;">
                    ‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi camera
                </div>

                <!-- Video Controls Inside Container -->
                <div class="video-controls-overlay">
                    <button onclick="takeScreenshot()" class="btn-overlay btn-primary">
                        üì∏ Ch·ª•p ·∫£nh
                    </button>
                    <button onclick="refreshStream()" class="btn-overlay btn-secondary">
                        üîÑ L√†m m·ªõi
                    </button>
                    <button id="yoloDetectBtn" onclick="toggleYOLODetection()" class="btn-overlay btn-yolo">
                        ü§ñ YOLO Detection
                    </button>
                </div>
            </div>
        </div>

        <div class="gallery-section">
            <div class="gallery-header">
                <h2>üì∑ ·∫¢nh ƒë√£ ch·ª•p (<span id="photoCount">0</span>)</h2>
                <button onclick="clearGallery()" class="btn btn-danger" id="clearBtn" style="display: none;">
                    üóëÔ∏è X√≥a t·∫•t c·∫£
                </button>
            </div>
            <div id="gallery" class="gallery-grid"></div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/yolo_websocket.js') }}"></script>

    <script>
        // Pass data to module
        window.DRIVER_ID = {{ driver.id }};
        window.SNAPSHOT_URL = '{{ driver.stream_url }}'.replace('/video_feed/', '/snapshot/');
        window.STREAM_URL = '{{ driver.stream_url }}';

        // YOLO Detection state
        let isYOLODetecting = false;
        let originalStreamUrl = '{{ driver.stream_url }}';
        let yoloStreamer = null;

        async function toggleYOLODetection() {
            const btn = document.getElementById('yoloDetectBtn');

            // Xem video th√¥ng th∆∞·ªùng (MJPEG stream) khi kh√¥ng b·∫≠t YOLO Detection
            const videoStream = document.getElementById('videoStream');

            // Xem video c√≥ YOLO detection (WebSocket stream) khi b·∫≠t YOLO Detection
            const yoloCanvas = document.getElementById('yoloCanvas');
            const loadingOverlay = document.getElementById('loadingOverlay');

            if (!isYOLODetecting) {
                // Start YOLO Detection with WebSocket
                try {
                    btn.disabled = true;
                    btn.textContent = '‚è≥ ƒêang kh·ªüi ƒë·ªông...';
                    loadingOverlay.style.display = 'flex';

                    // Kh·ªüi t·∫°o WebSocket streamer
                    if (!yoloStreamer) {
                        yoloStreamer = new YOLOWebSocketStreamer(originalStreamUrl);
                        yoloStreamer.initCanvas(yoloCanvas);
                        yoloStreamer.connect();
                    }

                    // G·ªçi API ƒë·ªÉ b·∫Øt ƒë·∫ßu detection
                    const response = await fetch('/api/yolo/start', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            stream_url: originalStreamUrl
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        isYOLODetecting = true;

                        // ·∫®n img, hi·ªán canvas
                        videoStream.style.display = 'none';
                        yoloCanvas.style.display = 'block';

                        // B·∫Øt ƒë·∫ßu stream qua WebSocket
                        yoloStreamer.startStream();

                        btn.textContent = '‚èπÔ∏è D·ª´ng YOLO';
                        btn.classList.remove('btn-yolo');
                        btn.classList.add('btn-danger');
                        loadingOverlay.style.display = 'none';
                    } else {
                        alert(`L·ªói: ${result.error}`);
                        btn.textContent = 'ü§ñ YOLO Detection';
                        loadingOverlay.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error starting YOLO:', error);
                    alert('Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu YOLO detection');
                    btn.textContent = 'ü§ñ YOLO Detection';
                    loadingOverlay.style.display = 'none';
                } finally {
                    btn.disabled = false;
                }
            } else {
                // Stop YOLO Detection
                try {
                    btn.disabled = true;
                    btn.textContent = '‚è≥ ƒêang d·ª´ng...';
                    loadingOverlay.style.display = 'flex';

                    // D·ª´ng WebSocket stream
                    if (yoloStreamer) {
                        yoloStreamer.stopStream();
                    }

                    const response = await fetch('/api/yolo/stop', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            stream_url: originalStreamUrl
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        isYOLODetecting = false;

                        // ·∫®n canvas, hi·ªán img
                        yoloCanvas.style.display = 'none';
                        videoStream.style.display = 'block';

                        // Chuy·ªÉn v·ªÅ stream g·ªëc
                        videoStream.src = `${originalStreamUrl}?t=${Date.now()}`;

                        btn.textContent = 'ü§ñ YOLO Detection';
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-yolo');
                        loadingOverlay.style.display = 'none';
                    } else {
                        alert(`L·ªói: ${result.error}`);
                        loadingOverlay.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error stopping YOLO:', error);
                    alert('Kh√¥ng th·ªÉ d·ª´ng YOLO detection');
                    loadingOverlay.style.display = 'none';
                } finally {
                    btn.disabled = false;
                }
            }
        }
    </script>
    <script type="module" src="{{ url_for('static', filename='js/driver_view_module.js') }}"></script>
</body>

</html>